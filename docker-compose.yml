version: '3.8'

services:
  # ============================================
  # AUTH & APP DIENSTE
  # ============================================

  # 1. Keycloak-Dienst
  keycloak:
    image: quay.io/keycloak/keycloak:22.0.5
    container_name: keycloak
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HTTP_PORT: 8080
      KC_HOSTNAME_URL: http://localhost:8080
      KC_PROXY: "edge"
    command: start-dev 
    ports:
      - "8080:8080"
    volumes:
      - keycloak_data:/opt/keycloak/data
    networks:
      - mein-netzwerk

  # 2. Backend-Dienst
  backend:
    build:
      context: .
      dockerfile: app/Dockerfile.backend 
    container_name: backend
    environment:
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/labor-projekt 
      KEYCLOAK_AUDIENCE: backend-client
      # Influx DB Konfiguration
      INFLUXDB_URL: http://influxdb:8086
      INFLUXDB_TOKEN: "MeinSicheresInfluxToken-Labor-2025!" # <-- WICHTIG: Setze hier das Token von unten!
      INFLUXDB_ORG: "labor-projekt-org"
      INFLUXDB_BUCKET: "labor-projekt-bucket"
    ports:
      - "8001:8001" 
    volumes:
      - ./app:/home/appuser/app 
    networks:
      - mein-netzwerk
    depends_on:
      - keycloak
      - influxdb 

  # 3. Frontend-Dienst
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.frontend 
    container_name: frontend
    ports:
      - "3001:3000" 
    environment:
      NEXTAUTH_URL: http://localhost:3001
      NEXTAUTH_SECRET: "smartcampus2025" 
      KEYCLOAK_ID: "frontend-client" 
      KEYCLOAK_SECRET: "WKUMwDr3op9PA753bmpQMT96T1kk8riN"
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/labor-projekt
    volumes:
      - ./frontend:/app 
      - /app/node_modules
      - /app/.next
    networks:
      - mein-netzwerk
    depends_on:
      - backend

  # ============================================
  # NEUE DIENSTE (DATENBANK & DASHBOARDS)
  # ============================================

  # 4. InfluxDB (Neu)
  influxdb:
    image: influxdb:2.7 
    container_name: influxdb
    ports:
      - "8087:8086" 
    volumes:
      - influxdb_data:/var/lib/influxdb2
    networks:
      - mein-netzwerk
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: admin
      DOCKER_INFLUXDB_INIT_PASSWORD: adminpassword
      DOCKER_INFLUXDB_INIT_ORG: "labor-projekt-org"
      DOCKER_INFLUXDB_INIT_BUCKET: "labor-projekt-bucket"
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: "MeinSicheresInfluxToken-Labor-2025!" # <-- Kopiere dieses Token nach oben zum Backend!

  # 5. Grafana (Neu)
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000" 
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - mein-netzwerk
    environment:
      GF_SECURITY_ALLOW_EMBEDDING: "true"
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: "Viewer"
      GF_SECURITY_COOKIE_SAMESITE: "lax"
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: "super-sicheres-passwort-123!"
    depends_on:
      - influxdb

  # 6. Node-RED (Neu)
  nodered:
    image: nodered/node-red:latest
    container_name: nodered
    ports:
      - "1880:1880"
    volumes:
      - nodered_data:/data
    networks:
      - mein-netzwerk
    depends_on:
      - influxdb

# ============================================
# VOLUMES & NETZWERKE
# ============================================

volumes:
  keycloak_data:
  influxdb_data: 
  grafana_data:  
  nodered_data:  

networks:
  mein-netzwerk:
    driver: bridge



